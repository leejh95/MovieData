<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="movie">

	<!-- 회원 로그인 -->
	<select id="sign_in" resultType="mybatis.vo.MovieMemberVO" parameterType="java.util.Map">
		select * from Movie_Mem where id = #{id} and pw = #{pw} and status = 0
	</select>
	
	<!-- sns 로그인 -->
	<select id="sign_in_naver" resultType="mybatis.vo.MovieMemberVO" parameterType="java.util.Map">
		select * from Movie_Mem where sns_id = #{sns_id} and sns_type = #{sns_type} and status = 0
	</select>

	<!-- 회원 가입 -->
	<insert id="sign_up" parameterType="mybatis.vo.MovieMemberVO">
		insert into Movie_Mem(m_idx <if test="id != null">, id</if> <if test="pw != null">, pw</if>, name, email <if test="phone != null">, phone</if>, reg_date, status <if test="sns_id != null">, sns_id</if> <if test="sns_type != null">, sns_type</if>)
		values(Movie_Mem_seq.nextval <if test="id != null">, #{id}</if> <if test="pw != null">, #{pw}</if>, #{name}, #{email} <if test="phone != null">, #{phone}</if>, sysdate, 0 <if test="sns_id != null">, #{sns_id}</if> <if test="sns_type != null">, #{sns_type}</if>)
	</insert>
	
	<!-- 페이징 기법에 사용될 전체 게시물의 수를 반환하는 기능 -->
	<select id="totalCount" resultType="int" parameterType="String">
		select count(*) from movie_board where category = #{category} and status = 0 or status = 2
	</select>
	
	<!-- 게시물 쓰기 -->
	<insert id="writeBoard" parameterType="mybatis.vo.MovieBoardVO">
		insert into movie_board(b_idx, subject, content, file_name, ori_name, write_date, ip, hit, ref, step, sunbun, status, category, m_idx)
		values(movie_board_seq.nextval, #{subject}, #{content}, #{file_name}, #{ori_name}, sysdate, #{ip}, 0, movie_board_ref.nextval, 0, 0, 0, #{category}, #{m_idx})
	</insert>
	
	<!-- 댓글 쓰기  -->
	<insert id="writeComment" parameterType="mybatis.vo.MovieCommentVO">
		insert into Movie_Comm(c_idx, content, write_date, ip, status, movieCd, m_idx, rate) 
		values(Movie_Comm_seq.nextval, #{content}, sysdate, #{ip}, 0, #{movieCd}, #{m_idx}, #{rate})
	</insert>
	
	<!-- 하나의 영화 포스트에 대한 댓글 모음 -->
	<!-- 시작 -->
	<select id="commList" resultMap="map1" parameterType="String">
		select * from Movie_Comm where movieCd = #{movieCd} and status = 0 order by c_idx asc
	</select>
	
	<resultMap type="mybatis.vo.MovieCommentVO" id="map1">
		<result column="m_idx" property="m_idx"/>
		<association property="mvo" javaType="mybatis.vo.MovieMemberVO" select="commList_getMvo" column="m_idx"/>
	</resultMap>
	
	<select id="commList_getMvo" resultType="mybatis.vo.MovieMemberVO" parameterType="String">
		select * from Movie_Mem where m_idx = #{m_idx} 
	</select>
	<!-- 끝 -->
	
	<!-- 회원정보 보기 -->
	<!-- 시작 -->
	<select id="getMember" resultMap="map2" parameterType="String">
		select * from Movie_Mem where m_idx = #{m_idx} 
	</select>
	
	<resultMap type="mybatis.vo.MovieMemberVO" id="map2">
		<id column="m_idx" property="m_idx"/>
		<collection property="c_list" ofType="mybatis.vo.MovieCommentVO" select="getMember_commList" column="m_idx"/>
	</resultMap>
	
	<select id="getMember_commList" resultType="mybatis.vo.MovieCommentVO" parameterType="String">
		select * from Movie_Comm where m_idx = #{m_idx} and status = 0 order by c_idx asc
	</select>
	<!-- 끝 -->
	
	<!-- 해당 페이지마다 보여질 게시물 목록 -->
	<!-- 시작 -->
	<select id="getBoardList" resultMap="map3" parameterType="java.util.Map">
		select * from(
			select rownum as r_num, a.* from
			(select * from movie_board where category = #{category} and status = 0 or status = 2 order by ref desc, sunbun asc) a
		) where r_num between #{begin} and #{end}
	</select>
	
	<resultMap type="mybatis.vo.MovieBoardVO" id="map3">
		<id column="b_idx" property="b_idx"/>
		<collection property="c_list" ofType="mybatis.vo.MovieCommentVO" select="getBoard_commList" column="b_idx"/>
	</resultMap>
	
	<select id="getBoard_commList" resultMap="map1" parameterType="String">
		select * from Movie_Comm where b_idx = #{b_idx} and status = 0 order by c_idx asc
	</select>
	<!-- 끝 -->
	
	<!-- 회원 가입시 아이디 일치 -->
	<select id="searchID" resultType="String" parameterType="String">
		select id from Movie_Mem where id = #{id}
	</select>
	
	<!-- 회원 정보 수정 -->
	<update id="updateMember" parameterType="mybatis.vo.MovieMemberVO">
		update Movie_Mem
		<set>
			<trim suffixOverrides=",">
				<if test="pw != null">
					pw = #{pw},
				</if>
				<if test="name != null">
					name = #{name},
				</if>
				<if test="email != null">
					email = #{email},
				</if>
				<if test="phone != null">
					phone = #{phone},
				</if>
			</trim>
		</set>
		where m_idx = #{m_idx}
	</update>
	
	<!-- 회원 탈퇴 -->
	<update id="delMember" parameterType="java.util.Map">
		update Movie_Mem set status = 1 where m_idx = #{m_idx} and pw = #{pw}
	</update>
	
	<!-- 댓글 삭제 -->
	<update id="delComment" parameterType="String">
		update Movie_Comm set status = 1 where c_idx = #{c_idx}
	</update>
	
	<!-- 댓글 수정 -->
	<update id="updateComment" parameterType="mybatis.vo.MovieCommentVO">
		update Movie_Comm 
		set content = #{content}, write_date = sysdate, ip = #{ip}, rate = #{rate}
		where c_idx = #{c_idx} 
	</update>
	
	<!-- 영화 별점 평균 -->
	<select id="rateAvg" parameterType="String" resultType="String">
		Select AVG(RATE)
		From MOVIE_COMM
		Where MOVIECD = #{movieCd}
	</select>
	
</mapper>